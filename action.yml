name: Android Public Build

inputs:
  token:
    required: true

runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v2
    
    - name: LF gradlew line endings
      run: sed -i 's/\r$//' gradlew
      shell: bash

    - name: Build release APK
      run: bash gradlew assembleRelease
      shell: bash

    - name: Get tag
      id: tag
      run: |
        tag="$(git rev-parse --short HEAD)_$(date +%s)"
        echo "::set-output name=tag::$tag"
      shell: bash

    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      with:
        tag_name: build-${{ steps.tag.outputs.tag }}
        release_name: Build ${{ steps.tag.outputs.tag }}

    - name: Fetch public keystore
      run: wget https://github.com/tytydraco/public-keystore/raw/main/public.jks
      shell: bash

    - name: Sign release APK
      run: |
        apksigner="$(find $ANDROID_SDK_ROOT/build-tools -name apksigner | sort -r | head -n 1)"
        "$apksigner" sign --ks public.jks --ks-key-alias public --ks-pass pass:public --key-pass pass:public --in ./app/build/outputs/apk/release/app-release-unsigned.apk --out ./app/build/outputs/apk/release/app-release.apk
      shell: bash

    - name: Upload signed release APK
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./app/build/outputs/apk/release/app-release.apk
        asset_name: app-release.apk
        asset_content_type: application/apk
